---
title: "TSIC Getting Started"
author: "Phillip Labuschagne"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TSIC Getting Started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This guide assumes that you successfully installed `tsic` - this is when you run `library(tsic)` in R, you do not get any errors.

```{r}
library(tsic)
```

The current version of the guide will only consider a single participant. You have to write the code that will read in your datasets and that will loop over the individual persons in the dataset and select out their data into the format that `tsic` requires. Feel free to ask the package author for help.

The main data structure is the diagnostic history which contains a single patient's test result history. This is usually assigned to a variable named `ihist` (which is short of individual history). Below is an example of such an history. The column names and order must be matched exactly.

```{r}
ihist <- data.frame(
  ptid = c('p0', 'p0'),
  sample_date = c(as.numeric(as.Date('2019-04-01')), as.numeric(as.Date('2019-05-01'))),
  test = c('architect_weib3_delaney', 'architect_weib3_delaney'),
  result = c('-', '+'),
  stringsAsFactors = FALSE
)
ihist$sample_date <- ihist$sample_date + 0.5
```

```{r echo=FALSE,results='asis'}
knitr::kable(ihist)
```

Note: `sample_date` is expressed as a `numeric`. (The number of days since 1970-01-01)

Note: It will almost always make sense to add 0.5 to the sample date, since it is more likely that the visit occurred at noon than at midnight.

Note: The test names must match those available from the `get_assay_dynamics()` function. Listed below:

```{r}
# running this will print the available assays
get_assay_dynamics()
```

The next step is to construct a function that computes the probability of observing *all* the results in the `ihist` for a given infection date. This is done by calling the `construct_aggregate_interpreter` function on the `ihist`. The value returned from `construct_aggregate_interpreter` is a function that takes a date (expressed as the number of days since 1970-01-01) as input and returns a probability. This returned function is assigned to the variable `agg_interpreter` which is short for aggregate interpreter.

```{r}
agg_interpreter <- construct_aggregate_interpreter(ihist)
class(agg_interpreter)
agg_interpreter(17928) # 2019-02-01
agg_interpreter(17988) # 2019-04-02
agg_interpreter(18020) # 2019-05-04
```

In computer programming terminology, `agg_interpreter` is called a [closure](https://en.wikipedia.org/wiki/Closure_(computer_programming)).

Next you have to compute the various percentiles of `agg_interpreter` curve. This is done with the `estimate_lb_meb_ub` function. `estimate_lb_med_ub` will normalize `agg_interpreter` as required. 
```{r}
range_start <- min(ihist$sample_date) - 100
range_end <- max(ihist$sample_date) + 100
lb_med_ub <- estimate_lb_med_ub(fun = agg_interpreter,                            
                                range_start = range_start,
                                range_end = range_end,
                                verbose = TRUE)
print(lb_med_ub)
```

`estimate_lb_med_ub` returns a list. The `lb`, `med` and `ub` elements are the 2.5th, 50th and 97.5th percentiles of the distribution obtained when normalizing `agg_interpreter`. These quantities are estimate (50th) of the infection date as well as the 95% uncertainty interval.

The `aoc` element of the list is the total area under the non-normalized `agg_interpreter` and the `max_agg` element is the maximum value the function attains.

A key application of `tsic` is to compute the amount of mass that falls in specific intervals. The `estimate_lb_med_ub` function's `date_splits` argument facilitates this. For each date in `date_splits`, `estimate_lb_med_ub` will compute the area under the normalized version of `agg_interpreter` that is to the left of that date. For the current example, if you want to compute the total mass between the two visit dates, to supply both dates to `estimate_lb_med_ub` via the `date_splits` argument and then subtract the two results from each other.

```{r}
range_start <- min(ihist$sample_date) - 100
range_end <- max(ihist$sample_date) + 100
lb_med_ub <- estimate_lb_med_ub(fun = agg_interpreter,                            
                                range_start = range_start,
                                range_end = range_end,
                                verbose = TRUE,
                                date_splits = c(17987.5, 18017.5))
print(lb_med_ub)
```

The probability that the infection date was between `r as.Date(17987, origin = '1970-01-01')` and `r as.Date(18017, origin = '1970-01-01')` is `r lb_med_ub$date_splits[2] - lb_med_ub$date_splits[1]`

You will probably have to write some code to compute the values you want to supply to `date_splits` for each person.






TODO: process everything below this line.

A key internal step of tsic is to interpret an ihist. This is the process by which the individual results are interpreted into curves that describe the probability (indicated by the y-axis) of observing the result for various possible infection dates (indicated by the x-axis). Since `tsic` should be able to operate accurately on step functions (which have discontinuities in their derivatives), there is a fair bit going on in the `interpret_ihist` function.

The `range_start` and `range_end` arguments should be set to such values that at least one of the curves will be extremely close to 0 outside of the range.

```{r}
iihist <- interpret_ihist(ihist = ihist,
                          range_start = as.numeric(as.Date('2019-02-01')),
                          range_end = as.numeric(as.Date('2019-06-15')),
                          verbose = FALSE)
```

```{r echo=FALSE,results='asis'}
tmp_iihist <- iihist
tmp_iihist$test_details <- gsub('\\\n', ' ', tmp_iihist$test_details)
knitr::kable(tmp_iihist[1:15,])
rm(tmp_iihist)
```




